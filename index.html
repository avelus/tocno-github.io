<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Točnostni reli – korekcija</title>
  <style>
    :root {
      font-size: 16px;
      --bg: #0F172A;
      --panel: #111827;
      --text: #E5E7EB;
      --muted: #9CA3AF;
      --accent: #60A5FA;
      --positive: #14B8A6;
      --warning: #F59E0B;
      --border: #1F2937;
      --touch: 2.75rem;
      --touch-lg: 3.0rem;
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font-family: system-ui, "Segoe UI", Roboto, Arial, sans-serif; }
    .page { max-width: 720px; margin: 0 auto; padding: 1rem; }
    /* Glava */
    .header { display:flex; justify-content:space-between; align-items:flex-end; gap:1rem; margin-bottom:1rem; }
    .header h1 { font-size:1.2rem; margin:0; color:var(--text); }
    /* Hero: Potrebna + Trenutna hitrost */
    .hero { background:var(--panel); border:1px solid var(--border); border-radius:.75rem; padding:1rem; margin-bottom:1rem; }
    .hero-row { display:flex; align-items:flex-end; justify-content:space-between; gap:1rem; }
    .hero-speed { display:flex; align-items:baseline; gap:.5rem; }
    .hero .req-number { font-weight:800; font-size:4.5rem; line-height:1.1; color:var(--accent); }
    .hero .unit { font-size:1.4rem; color:var(--muted); }
    /* Trenutna hitrost: polovica višine zahtevane */
    .current { display:flex; align-items:baseline; gap:.35rem; }
    .current .cur-number { font-weight:700; font-size:2.25rem; line-height:1.1; color:#E2E8F0; }
    .current .label { font-size:.9rem; color:var(--muted); display:block; }
    .hero-meta { margin-top:.5rem; display:grid; gap:.25rem; font-size:1rem; color:var(--muted); }
    .hero-meta strong { color:var(--text); }
    /* Plošče */
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:.75rem; padding:1rem; margin-bottom:1rem; }
    .panel-header { display:flex; align-items:center; justify-content:space-between; gap:1rem; }
    .panel-header h2 { font-size:1.05rem; margin:0; }
    .panel-header .hint { margin:.25rem 0 0; font-size:.9rem; color:var(--muted); }
    .two-cols { display:grid; grid-template-columns: 1fr auto; gap:1rem; align-items:center; }
    input[type="number"] { height: var(--touch-lg); width: 8rem; padding: 0 .75rem; font-size: 1.1rem; color: var(--text); background: #0B1220; border: 1px solid var(--border); border-radius: .5rem; }
    /* IDEALNA HITROST: manjši drsnik */
    .range-small { width: 100%; height: 1rem; background: transparent; }
    .range-small::-webkit-slider-runnable-track { height: .5rem; background: #334155; border-radius: .5rem; }
    .range-small::-webkit-slider-thumb { -webkit-appearance: none; margin-top: -.55rem; width: 1.2rem; height: 1.2rem; border-radius: 50%; background: #D1D5DB; border: 2px solid #93C5FD; }
    /* ZAMUDA: večja površina (debeli track + velik thumb) */
    .slider-hit { padding: .8rem 0 1rem; }
    .range-large { width: 100%; height: 1.8rem; background: transparent; }
    .range-large::-webkit-slider-runnable-track { height: 1.6rem; background: linear-gradient(90deg, var(--positive), #334155 50%, var(--warning)); border-radius: .9rem; }
    .range-large::-webkit-slider-thumb { -webkit-appearance: none; margin-top: -.7rem; width: 2.8rem; height: 2.8rem; border-radius: 50%; background: #F8FAFC; border: 3px solid #93C5FD; box-shadow: 0 0 0 8px rgba(147,197,253,0.15); }
    /* Številka zamude zgoraj desno v glavi panela (30% večja) */
    .delay-display { height: calc(var(--touch-lg) * 1.15);
      width: 8.5rem; padding: 0 .75rem; font-size: 1.43rem; font-weight: 700; color: var(--text);
      background: #0B1220; border: 1px solid var(--border); border-radius: .5rem; text-align: right; }
    /* Nastavitve */
    .settings h3 { margin:0 0 .75rem 0; font-size:1.05rem; }
    .settings-grid { display:grid; gap:1rem; }
    .setting-block label { display:block; margin-bottom:.25rem; color:var(--muted); }
    .pair { display:flex; gap:.75rem; }
    .segment-buttons { display:flex; flex-wrap:wrap; gap:.5rem; }
    .seg-btn { min-width: 6rem; height: var(--touch); border-radius: .5rem; border: 1px solid var(--border); background: #0B1220; color: var(--text); font-size: 1rem; }
    .seg-btn.active { background: var(--accent); color: #0B1220; border-color: #93C5FD; }
    .picked { margin-top:.5rem; color:var(--muted); }
    @media (max-width: 380px) {
      .page { padding: .75rem; }
      .hero .req-number { font-size: 3.8rem; }
      .current .cur-number { font-size: 1.9rem; }
      .delay-display { font-size: 1.25rem; width: 7.5rem; }
      input[type="number"] { width: 6.5rem; }
    }
  </style>
</head>
<body>
  <div class="page dark">
    <header class="header">
      <h1>Točnostni reli – korekcija</h1>
    </header>
    <main>
      <!-- Hero: Potrebna + Trenutna -->
      <section class="hero">
        <div class="hero-row">
          <div class="hero-speed">
            <span id="requiredSpeed" class="req-number">20.0</span>
            <span class="unit">km/h</span>
          </div>
          <div class="current">
            <div>
              <span class="label">Trenutna</span>
              <span id="gpsSpeed" class="cur-number">--.-</span>
              <span class="unit">km/h</span>
            </div>
          </div>
        </div>
        <div class="hero-meta">
          <div>Sprememba: <strong id="deltaSpeed">--.- km/h</strong></div>
          <div>Ciljni čas: <strong id="targetTime">35.96 s</strong></div>
          <div>Če ohraniš: <strong id="saveTime">--.- s</strong></div>
        </div>
      </section>

      <!-- Idealna hitrost -->
      <section class="panel">
        <div class="panel-header"><h2>Idealna hitrost (km/h)</h2></div>
        <div class="panel-body two-cols">
          <input class="range-small" type="range" id="idealSpeed" min="10" max="120" step="0.5" />
          <input type="number" id="idealSpeedInput" min="10" max="120" step="0.5" value="47.5" />
        </div>
      </section>

      <!-- Zamuda / prehitevanje -->
      <section class="panel">
        <div class="panel-header">
          <div>
            <h2>Zamuda / prehitevanje (sekunde)</h2>
            <p class="hint">Negativna = zamuda, pozitivna = prehitevanje</p>
          </div>
          <!-- IZPIS prestavljen višje v glavo panela, 30% večji -->
          <input class="delay-display" type="number" id="delayInput" min="-60" max="60" step="0.1" value="-1.2" />
        </div>
        <div class="panel-body slider-hit">
          <input class="range-large" type="range" id="delay" min="-60" max="60" step="0.1" />
        </div>
      </section>

      <!-- Nastavitve -->
      <section class="panel settings">
        <h3>Nastavitve</h3>
        <div class="settings-grid">
          <div class="setting-block">
            <label>Idealna hitrost min / max (km/h)</label>
            <div class="pair">
              <input type="number" id="idealMin" value="10" />
              <input type="number" id="idealMax" value="120" />
            </div>
          </div>
          <div class="setting-block">
            <label>Zamuda min / max (sekunde)</label>
            <div class="pair">
              <input type="number" id="delayMin" value="-60" />
              <input type="number" id="delayMax" value="60" />
            </div>
          </div>
          <div class="setting-block">
            <label>Dolžina odseka</label>
            <div id="segmentButtons" class="segment-buttons">
              <button data-seg="50" class="seg-btn">50 m</button>
              <button data-seg="100" class="seg-btn active">100 m</button>
              <button data-seg="150" class="seg-btn">150 m</button>
              <button data-seg="200" class="seg-btn">200 m</button>
            </div>
            <div class="picked">Izbrano: <strong id="segmentPicked">100 m</strong></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ====== Elementi (UI) ======
    const reqSpeed = document.getElementById('requiredSpeed');
    const gpsSpeedEl = document.getElementById('gpsSpeed');
    const idealSlider = document.getElementById('idealSpeed');
    const idealInput = document.getElementById('idealSpeedInput');
    const delaySlider = document.getElementById('delay');
    const delayInput = document.getElementById('delayInput');
    const idealMin = document.getElementById('idealMin');
    const idealMax = document.getElementById('idealMax');
    const delayMin = document.getElementById('delayMin');
    const delayMax = document.getElementById('delayMax');

    // Konvencija prikaza: Zamuda = NEGATIVNA, Prehitevanje = POZITIVNA
    // Pretvorbe
    const kmhToMps = v => v / 3.6;
    const mpsToKmh = v => v * 3.6;

    // Segment dolžina (m)
    function getSegmentLength(){
      const activeBtn = document.querySelector('.seg-btn.active');
      const L = activeBtn ? parseFloat(activeBtn.dataset.seg) : 100; // privzeto 100 m
      return isFinite(L) ? L : 100;
    }

    // Glavna funkcija: izračun potrebne hitrosti glede na zamudo in dolžino odseka
    function computeRequiredSpeed(ideal_kmh, displayDelay_s, segment_m){
      const vIdeal_mps = kmhToMps(ideal_kmh);
      const tIdeal_s = segment_m / vIdeal_mps; // čas vožnje odseka pri idealni hitrosti
      const delaySeconds = -displayDelay_s;    // invert po konvenciji prikaza
      let tReq_s = tIdeal_s - delaySeconds;    // želena povprečna čas vožnje na odseku
      const MIN_T = 0.5;                       // varnostni minimum za izračun (0.5 s)
      if (tReq_s < MIN_T) tReq_s = MIN_T;      // prepreči nerealne hitrosti (delitev z ~0)
      const vReq_mps = segment_m / tReq_s;     // povprečna potrebna hitrost
      return mpsToKmh(vReq_mps);
    }

    function updateRequiredSpeed(){
      const ideal = parseFloat(idealSlider.value || idealInput.value || '0');
      const displayDelay = parseFloat(delayInput.value || delaySlider.value || '0');
      const L = getSegmentLength();
      const required = Math.max(0, computeRequiredSpeed(ideal, displayDelay, L));
      reqSpeed.textContent = required.toFixed(1);
      const deltaEl = document.getElementById('deltaSpeed');
      if (deltaEl) deltaEl.textContent = (required - ideal).toFixed(1) + ' km/h';
    }

    // Sinhronizacija range <-> number
    const syncRangeNumber = (rangeEl, numEl, onChange) => {
      rangeEl?.addEventListener('input', e => { numEl.value = e.target.value; onChange?.(); });
      numEl?.addEventListener('input', e => { rangeEl.value = e.target.value; onChange?.(); });
    };
    syncRangeNumber(idealSlider, idealInput, updateRequiredSpeed);
    syncRangeNumber(delaySlider, delayInput, updateRequiredSpeed);

    // Obseg drsnikov iz Nastavitev
    function clamp(v, min, max){ return Math.min(Math.max(v, min), max); }
    function applyRange(slider, input, minEl, maxEl) {
      const min = parseFloat(minEl.value), max = parseFloat(maxEl.value);
      if (Number.isFinite(min)) slider.min = input.min = min;
      if (Number.isFinite(max)) slider.max = input.max = max;
      const v = parseFloat(input.value);
      const nv = clamp(v, min, max);
      slider.value = input.value = String(nv);
    }
    function applyAll(){
      applyRange(idealSlider, idealInput, idealMin, idealMax);
      applyRange(delaySlider, delayInput, delayMin, delayMax);
      updateRequiredSpeed();
    }
    [idealMin, idealMax, delayMin, delayMax].forEach(el => el?.addEventListener('input', applyAll));

    // Segment gumbi: vizualno označi izbranega + live izračun
    document.getElementById('segmentButtons')?.addEventListener('click', (e) => {
      const btn = e.target.closest('button.seg-btn');
      if(!btn) return;
      document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const picked = document.getElementById('segmentPicked');
      if(picked) picked.textContent = btn.dataset.seg + ' m';
      updateRequiredSpeed();
    });

    // ====== Geolocation: spremljanje hitrosti ======
    (function () {
      if (!('geolocation' in navigator)) {
        gpsSpeedEl.textContent = 'Ni GPS';
        return;
      }

      // Preprost EMA filter
      let ema = null;
      const alpha = 0.35; // 0..1 (višje = manj glajenja)

      // Prejšnja točka za izračun hitrosti (fallback)
      let prevFix = null; // {lat, lon, tMs, acc}

      function toRad(deg){ return deg * Math.PI / 180; }
      function haversineMeters(lat1, lon1, lat2, lon2){
        const R = 6371000; // m
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      function displaySpeedKmh(kmh) {
        gpsSpeedEl.textContent = kmh.toFixed(1);
        // Po želji lahko tu sprožiš reaktivnost UI:
        // updateRequiredSpeed();
      }

      const watchId = navigator.geolocation.watchPosition(
        pos => {
          const { latitude: lat, longitude: lon, speed: sMps, accuracy: acc } = pos.coords;
          const tMs = pos.timestamp; // ms od epoh

          let kmhFromSensor = null;
          if (sMps != null && Number.isFinite(sMps)) {
            kmhFromSensor = mpsToKmh(sMps);
          }

          let kmh;
          if (kmhFromSensor != null) {
            kmh = kmhFromSensor;
          } else if (prevFix) {
            const dt = (tMs - prevFix.tMs) / 1000; // s
            // pogoji za razumen izračun: dt 0.5..10 s, dobra natančnost
            const goodAcc = (prevFix.acc <= 50 && acc <= 50); // m
            if (dt > 0.5 && dt < 10 && goodAcc) {
              const d = haversineMeters(prevFix.lat, prevFix.lon, lat, lon);
              const vMps = d / dt;
              const vKmh = mpsToKmh(vMps);
              // zavrzi očitno nerealne skoke (npr. GPS glitch)
              if (Number.isFinite(vKmh) && vKmh <= 250) {
                kmh = vKmh;
              }
            }
          }

          // posodobi prevFix (tudi če ni kmh)
          prevFix = { lat, lon, tMs, acc };

          if (kmh == null) {
            gpsSpeedEl.textContent = '--.-';
            return;
          }

          // EMA glajenje
          ema = (ema == null) ? kmh : (alpha * kmh + (1 - alpha) * ema);
          displaySpeedKmh(ema);
        },
        err => {
          console.warn('Geolocation error:', err);
          gpsSpeedEl.textContent = '--.-';
        },
        {
          enableHighAccuracy: true, // zahteva GPS (večja poraba)
          maximumAge: 500,          // dovoljena starost podatka
          timeout: 10000            // koliko časa čaka na fix
        }
      );

      // Po potrebi: kasneje ustavi spremljanje
      // navigator.geolocation.clearWatch(watchId);
    })();

    // Inicializacija
    applyAll();
  </script>
</body>
</html>
